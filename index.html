<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>File Uploader</title>
  <script src="./dist/bundle.js"></script>
</head>
<body>


<file-uploader></file-uploader>
<file-clerk id="file_clerk" verbose="true"></file-clerk>
<file-viewer id="file_viewer"></file-viewer>
<file-splitter id="file_splitter"></file-splitter>
<file-archive id="file_archive" target="#file_clerk" verbose="true"></file-archive>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const fileUploader = document.querySelector('file-uploader');
    const fileClerkEl = document.getElementById('file_clerk');
    const fileViewerEl = document.getElementById('file_viewer');
    const fileSplitterEl = document.getElementById('file_splitter');

    // Ensure custom element is defined/upgraded before calling its methods
    const onClerkReady = customElements.whenDefined('file-clerk').then(() => {
      if (customElements.upgrade) {
        customElements.upgrade(fileClerkEl);
      }
    });

    // Wire uploader -> clerk save
    fileUploader.addEventListener('fileuploaded', async (event) => {
      await onClerkReady;
      const { fileData, name, notes } = event.detail;
      fileClerkEl.saveFile(name, fileData, notes);
    });

    // Initial list
    onClerkReady.then(() => {
      if (typeof fileClerkEl.listFiles === 'function') {
        fileClerkEl.listFiles().then((res) => console.log(res));
      }
    });

    // Open -> split -> view
    fileClerkEl.addEventListener('file-opened', async (e) => {
      const rejoined_file = fileSplitterEl.joinFiles(
        fileSplitterEl.splitFiles(e.detail.contents)
      );
      fileViewerEl.openFile(rejoined_file);
    });
  });
</script>


</body>
</html>